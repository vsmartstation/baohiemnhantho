<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Analytics Dashboard - BaoHiemNhanTho.org</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 70px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 16px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8fafc;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #ff6b35;
            transition: transform 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: #ff6b35;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #64748b;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .charts-section {
            padding: 30px;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #1e293b;
        }

        .driver-profiles {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .profile-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            position: relative;
            overflow: hidden;
        }

        .profile-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transform: translate(30px, -30px);
        }

        .profile-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .profile-icon {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 24px;
        }

        .profile-info h3 {
            font-size: 18px;
            margin-bottom: 5px;
        }

        .profile-info p {
            opacity: 0.8;
            font-size: 14px;
        }

        .profile-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .profile-stat {
            text-align: center;
        }

        .profile-stat-number {
            font-size: 20px;
            font-weight: 600;
        }

        .profile-stat-label {
            font-size: 12px;
            opacity: 0.8;
        }

        .insights-section {
            background: #1e293b;
            color: white;
            padding: 30px;
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .insight-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .insight-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #fbbf24;
        }

        .insight-text {
            line-height: 1.6;
            opacity: 0.9;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .data-table th {
            background: #f1f5f9;
            font-weight: 600;
            color: #475569;
        }

        .data-table tr:hover {
            background: #f8fafc;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            margin: 20px 0;
            transition: transform 0.2s ease;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .driver-profiles {
                grid-template-columns: 1fr;
            }
            
            .insights-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>üèçÔ∏è Driver Analytics Dashboard</h1>
            <p>Theo d√µi v√† ph√¢n t√≠ch d·ªØ li·ªáu t∆∞∆°ng t√°c v·ªõi t√†i x·∫ø c√¥ng ngh·ªá</p>
            <button class="refresh-btn" onclick="refreshData()">üîÑ Refresh Data</button>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="total-conversations">0</div>
                <div class="stat-label">T·ªïng cu·ªôc tr√≤ chuy·ªán</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="driver-users">0</div>
                <div class="stat-label">T√†i x·∫ø ƒë√£ t∆∞∆°ng t√°c</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avg-session">0</div>
                <div class="stat-label">Th·ªùi gian TB (ph√∫t)</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="completion-rate">0%</div>
                <div class="stat-label">T·ª∑ l·ªá ho√†n th√†nh profile</div>
            </div>
        </div>

        <div class="charts-section">
            <div class="chart-container">
                <h3 class="chart-title">üìä Ph√¢n b·ªë Platform T√†i x·∫ø</h3>
                <canvas id="platformChart" width="400" height="200"></canvas>
            </div>

            <div class="chart-container">
                <h3 class="chart-title">üí∞ Ph√¢n kh√∫c Thu nh·∫≠p</h3>
                <canvas id="incomeChart" width="400" height="200"></canvas>
            </div>

            <div class="chart-container">
                <h3 class="chart-title">üöó Lo·∫°i Ph∆∞∆°ng ti·ªán</h3>
                <canvas id="vehicleChart" width="400" height="200"></canvas>
            </div>
        </div>

        <div class="charts-section">
            <h3 class="chart-title">üë• Driver Personas Detected</h3>
            <div class="driver-profiles" id="driver-profiles">
                <!-- Dynamic content will be inserted here -->
            </div>
        </div>

        <div class="charts-section">
            <div class="chart-container">
                <h3 class="chart-title">üìà Conversation Flow Analysis</h3>
                <table class="data-table" id="conversation-table">
                    <thead>
                        <tr>
                            <th>Session ID</th>
                            <th>Platform</th>
                            <th>S·ªë c√¢u h·ªèi</th>
                            <th>AI Tier Used</th>
                            <th>Profile Completeness</th>
                            <th>Th·ªùi gian</th>
                        </tr>
                    </thead>
                    <tbody id="conversation-data">
                        <!-- Dynamic content -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="insights-section">
            <h2 style="text-align: center; margin-bottom: 10px;">üß† AI Insights & Recommendations</h2>
            <p style="text-align: center; opacity: 0.8; margin-bottom: 30px;">Ph√¢n t√≠ch th√¥ng minh t·ª´ d·ªØ li·ªáu t∆∞∆°ng t√°c</p>
            
            <div class="insights-grid" id="insights-grid">
                <!-- Dynamic insights will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        // Analytics Dashboard JavaScript
        class DriverAnalytics {
            constructor() {
                this.data = this.loadData();
                this.init();
            }

            loadData() {
                // Load from localStorage (in real app, this would be from API)
                const events = JSON.parse(localStorage.getItem('bh_events') || '[]');
                const profiles = JSON.parse(localStorage.getItem('driver_profiles') || '[]');
                
                return {
                    events: events,
                    profiles: profiles,
                    conversations: this.processConversations(events),
                    insights: this.generateInsights(events, profiles)
                };
            }

            processConversations(events) {
                const conversations = {};
                
                events.forEach(event => {
                    const sessionId = event.data.session_id || 'default';
                    
                    if (!conversations[sessionId]) {
                        conversations[sessionId] = {
                            id: sessionId,
                            messages: 0,
                            platform: 'unknown',
                            aiTiers: [],
                            profileCompleteness: 0,
                            startTime: event.timestamp,
                            endTime: event.timestamp
                        };
                    }
                    
                    const conv = conversations[sessionId];
                    
                    if (event.event === 'message_success') {
                        conv.messages++;
                        conv.profileCompleteness = event.data.driver_profile_completeness || 0;
                    }
                    
                    if (event.event === 'ai_tier_used') {
                        conv.aiTiers.push(event.data.tier);
                    }
                    
                    if (event.data.platform) {
                        conv.platform = event.data.platform;
                    }
                    
                    conv.endTime = event.timestamp;
                });
                
                return Object.values(conversations);
            }

            generateInsights(events, profiles) {
                const insights = [];
                
                // Platform popularity
                const platforms = {};
                events.forEach(e => {
                    if (e.data.platform) {
                        platforms[e.data.platform] = (platforms[e.data.platform] || 0) + 1;
                    }
                });
                
                const topPlatform = Object.keys(platforms).reduce((a, b) => 
                    platforms[a] > platforms[b] ? a : b, 'grab'
                );
                
                insights.push({
                    title: 'Platform Ph·ªï bi·∫øn nh·∫•t',
                    text: `${topPlatform.toUpperCase()} chi·∫øm ${Math.round((platforms[topPlatform] / Object.values(platforms).reduce((a,b) => a+b, 1)) * 100)}% t∆∞∆°ng t√°c. N√™n t·∫≠p trung marketing v√†o nh√≥m t√†i x·∫ø n√†y.`
                });

                // AI tier usage
                const aiTiers = {};
                events.filter(e => e.event === 'ai_tier_used').forEach(e => {
                    aiTiers[e.data.tier] = (aiTiers[e.data.tier] || 0) + 1;
                });
                
                const anthropicUsage = (aiTiers.anthropic || 0) / Object.values(aiTiers).reduce((a,b) => a+b, 1) * 100;
                
                insights.push({
                    title: 'M·ª©c ƒë·ªô Ph·ª©c t·∫°p C√¢u h·ªèi',
                    text: `${Math.round(anthropicUsage)}% c√¢u h·ªèi c·∫ßn AI cao c·∫•p (Anthropic). T√†i x·∫ø c√≥ xu h∆∞·ªõng h·ªèi nh·ªØng v·∫•n ƒë·ªÅ ph·ª©c t·∫°p v·ªÅ b·∫£o hi·ªÉm.`
                });

                // Conversation length
                const avgMessages = this.data.conversations.reduce((sum, conv) => sum + conv.messages, 0) / this.data.conversations.length || 0;
                
                insights.push({
                    title: 'M·ª©c ƒë·ªô Quan t√¢m',
                    text: `Trung b√¨nh ${Math.round(avgMessages)} c√¢u h·ªèi/phi√™n. T√†i x·∫ø c√≥ m·ª©c ƒë·ªô quan t√¢m cao v·ªÅ b·∫£o hi·ªÉm, ƒë·∫∑c bi·ªát l√† b·∫£o hi·ªÉm tai n·∫°n.`
                });

                // Profile completion
                const completedProfiles = this.data.conversations.filter(c => c.profileCompleteness >= 3).length;
                const completionRate = (completedProfiles / this.data.conversations.length) * 100 || 0;
                
                insights.push({
                    title: 'Thu th·∫≠p D·ªØ li·ªáu',
                    text: `${Math.round(completionRate)}% ng∆∞·ªùi d√πng chia s·∫ª th√¥ng tin c√° nh√¢n. C·∫ßn c·∫£i thi·ªán c√°ch ti·∫øp c·∫≠n ƒë·ªÉ tƒÉng t·ª∑ l·ªá n√†y.`
                });

                return insights;
            }

            updateStats() {
                // Total conversations
                document.getElementById('total-conversations').textContent = this.data.conversations.length;
                
                // Driver users (unique platforms detected)
                const uniqueDrivers = new Set(this.data.conversations.map(c => c.platform)).size;
                document.getElementById('driver-users').textContent = uniqueDrivers;
                
                // Average session time
                const avgDuration = this.data.conversations.reduce((sum, conv) => {
                    const start = new Date(conv.startTime);
                    const end = new Date(conv.endTime);
                    return sum + (end - start);
                }, 0) / this.data.conversations.length || 0;
                
                document.getElementById('avg-session').textContent = Math.round(avgDuration / 60000); // Convert to minutes
                
                // Completion rate
                const completedProfiles = this.data.conversations.filter(c => c.profileCompleteness >= 3).length;
                const completionRate = (completedProfiles / this.data.conversations.length) * 100 || 0;
                document.getElementById('completion-rate').textContent = Math.round(completionRate) + '%';
            }

            renderDriverProfiles() {
                const profilesContainer = document.getElementById('driver-profiles');
                
                const personas = [
                    {
                        icon: 'üèçÔ∏è',
                        title: 'Grab Biker',
                        description: 'T√†i x·∫ø xe m√°y Grab',
                        stats: { users: 45, avgIncome: '12tr', riskLevel: 'Cao' }
                    },
                    {
                        icon: 'üöó',
                        title: 'Be Driver',
                        description: 'T√†i x·∫ø √¥ t√¥ Be',
                        stats: { users: 23, avgIncome: '15tr', riskLevel: 'Trung b√¨nh' }
                    },
                    {
                        icon: 'üì¶',
                        title: 'Shipper',
                        description: 'T√†i x·∫ø giao h√†ng',
                        stats: { users: 31, avgIncome: '10tr', riskLevel: 'Cao' }
                    },
                    {
                        icon: 'üõµ',
                        title: 'Gojek Partner',
                        description: 'ƒê·ªëi t√°c Gojek',
                        stats: { users: 12, avgIncome: '11tr', riskLevel: 'Cao' }
                    }
                ];

                profilesContainer.innerHTML = personas.map(persona => `
                    <div class="profile-card">
                        <div class="profile-header">
                            <div class="profile-icon">${persona.icon}</div>
                            <div class="profile-info">
                                <h3>${persona.title}</h3>
                                <p>${persona.description}</p>
                            </div>
                        </div>
                        <div class="profile-stats">
                            <div class="profile-stat">
                                <div class="profile-stat-number">${persona.stats.users}</div>
                                <div class="profile-stat-label">Ng∆∞·ªùi d√πng</div>
                            </div>
                            <div class="profile-stat">
                                <div class="profile-stat-number">${persona.stats.avgIncome}</div>
                                <div class="profile-stat-label">Thu nh·∫≠p TB</div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            renderConversationTable() {
                const tableBody = document.getElementById('conversation-data');
                
                tableBody.innerHTML = this.data.conversations.slice(0, 10).map(conv => `
                    <tr>
                        <td>${conv.id.substring(0, 8)}...</td>
                        <td><strong>${conv.platform.toUpperCase()}</strong></td>
                        <td>${conv.messages}</td>
                        <td>${conv.aiTiers.join(', ') || 'deepseek'}</td>
                        <td>${conv.profileCompleteness}/7</td>
                        <td>${new Date(conv.startTime).toLocaleString('vi-VN')}</td>
                    </tr>
                `).join('');
            }

            renderInsights() {
                const insightsContainer = document.getElementById('insights-grid');
                
                insightsContainer.innerHTML = this.data.insights.map(insight => `
                    <div class="insight-card">
                        <div class="insight-title">${insight.title}</div>
                        <div class="insight-text">${insight.text}</div>
                    </div>
                `).join('');
            }

            drawCharts() {
                // Simple chart drawing (in real app, use Chart.js or similar)
                this.drawPlatformChart();
                this.drawIncomeChart();
                this.drawVehicleChart();
            }

            drawPlatformChart() {
                const canvas = document.getElementById('platformChart');
                const ctx = canvas.getContext('2d');
                
                // Sample data
                const data = [
                    { label: 'Grab', value: 45, color: '#00D632' },
                    { label: 'Be', value: 23, color: '#FFD700' },
                    { label: 'Gojek', value: 12, color: '#00AA13' },
                    { label: 'Kh√°c', value: 20, color: '#FF6B35' }
                ];
                
                this.drawPieChart(ctx, data, canvas.width, canvas.height);
            }

            drawIncomeChart() {
                const canvas = document.getElementById('incomeChart');
                const ctx = canvas.getContext('2d');
                
                const data = [
                    { label: '8-12tr', value: 40, color: '#FF6B35' },
                    { label: '12-15tr', value: 35, color: '#F7931E' },
                    { label: '15tr+', value: 25, color: '#FFD700' }
                ];
                
                this.drawBarChart(ctx, data, canvas.width, canvas.height);
            }

            drawVehicleChart() {
                const canvas = document.getElementById('vehicleChart');
                const ctx = canvas.getContext('2d');
                
                const data = [
                    { label: 'Xe m√°y', value: 75, color: '#667EEA' },
                    { label: '√î t√¥', value: 25, color: '#764BA2' }
                ];
                
                this.drawPieChart(ctx, data, canvas.width, canvas.height);
            }

            drawPieChart(ctx, data, width, height) {
                const centerX = width / 2;
                const centerY = height / 2;
                const radius = Math.min(width, height) / 3;
                
                let currentAngle = 0;
                const total = data.reduce((sum, item) => sum + item.value, 0);
                
                data.forEach(item => {
                    const sliceAngle = (item.value / total) * 2 * Math.PI;
                    
                    ctx.beginPath();
                    ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                    ctx.lineTo(centerX, centerY);
                    ctx.fillStyle = item.color;
                    ctx.fill();
                    
                    // Label
                    const labelAngle = currentAngle + sliceAngle / 2;
                    const labelX = centerX + Math.cos(labelAngle) * (radius + 30);
                    const labelY = centerY + Math.sin(labelAngle) * (radius + 30);
                    
                    ctx.fillStyle = '#333';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(`${item.label} (${item.value})`, labelX, labelY);
                    
                    currentAngle += sliceAngle;
                });
            }

            drawBarChart(ctx, data, width, height) {
                const margin = 40;
                const chartWidth = width - 2 * margin;
                const chartHeight = height - 2 * margin;
                const barWidth = chartWidth / data.length - 10;
                
                const maxValue = Math.max(...data.map(d => d.value));
                
                data.forEach((item, index) => {
                    const barHeight = (item.value / maxValue) * chartHeight;
                    const x = margin + index * (barWidth + 10);
                    const y = height - margin - barHeight;
                    
                    ctx.fillStyle = item.color;
                    ctx.fillRect(x, y, barWidth, barHeight);
                    
                    // Label
                    ctx.fillStyle = '#333';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(item.label, x + barWidth / 2, height - 10);
                    ctx.fillText(item.value, x + barWidth / 2, y - 5);
                });
            }

            init() {
                this.updateStats();
                this.renderDriverProfiles();
                this.renderConversationTable();
                this.renderInsights();
                this.drawCharts();
            }

            refresh() {
                this.data = this.loadData();
                this.init();
            }
        }

        // Global functions
        function refreshData() {
            analytics.refresh();
        }

        // Initialize dashboard
        const analytics = new DriverAnalytics();

        // Auto-refresh every 30 seconds
        setInterval(() => {
            analytics.refresh();
        }, 30000);

        console.log('Driver Analytics Dashboard loaded');
    </script>
</body>
</html>

